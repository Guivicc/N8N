//Recebe e processa a entrada do nó anterior
const variaveis = $input.first().json.estadoAtual;


//Extrai as variáveis do jogo usando desestruturação dinamico
const {
  A1, A2, A3, B1, B2, B3, C1, C2, C3, dificuldade, ultimaJogadaIa, ultimaJogadaPlayer
} = variaveis;

//Variáveis para o prompt final
let promptDificuldade
const jogadorIA = 'O'; 
//Cria a representação visual do tabuleiro para a IA
const representacaoTabuleiro =
`
  1 2 3
A ${A1 || ' '} ${A2 || ' '} ${A3 || ' '}
B ${B1 || ' '} ${B2 || ' '} ${B3 || ' '} 
C ${C1 || ' '} ${C2 || ' '} ${C3 || ' '}
`;

//preparação do prompt

if(dificuldade === "hard"){
  promptDificuldade = `Você é uma ia focada em ganhar no jogo da velha. seu objetivo é joga para ganhar, e se não puder ganhar não deixe o X ganhar. porém o voce vai jogar um jogo da velha dinamico onde tera no maximo 3 simbolos de cada, quando terminar sua rodada a casa ${ultimaJogadaIa} ficara vazia

AVALIE O TABULEIRO E EXECUTE A PRIMEIRA AÇÃO POSSÍVEL DESTA LISTA, EM ORDEM DE PRIORIDADE ESTRITA:

**HIERARQUIA DE JOGADA PERFEITA:**

1.  **GANHAR:** Se você ('${jogadorIA}') tem duas peças em uma linha, coluna ou diagonal, jogue na casa vazia para completar a trinca e vencer.

2.  **BLOQUEAR:** Se o oponente ('X') tem duas peças em uma linha, coluna ou diagonal, jogue na casa vazia para impedi-lo de vencer na próxima rodada.

3.  **BLOQUEAR GARFO DO OPONENTE:** Se o oponente está prestes a criar um garfo na próxima jogada dele, sua jogada deve ser para bloquear essa criação.
    * **Análise de Garfo:** A principal forma de o oponente criar um garfo é colocando uma peça em uma casa que cria duas linhas de duas peças não bloqueadas. Sua jogada deve ocupar essa casa crucial. Se houver múltiplas possibilidades de garfo, force o oponente a jogar defensivamente em vez de permitir que ele monte o ataque.

4.  **CRIAR GARFO (FORK):** Faça uma jogada que crie duas ameaças de vitória simultaneamente (duas linhas diferentes onde você tem duas peças). Isso força o oponente a bloquear uma, enquanto você vence na outra na próxima jogada.

5.  **JOGAR NO CENTRO:** Se a casa do centro (B2) estiver vazia, jogue nela.

6.  **JOGAR NO CANTO OPOSTO:** Se o oponente estiver em uma casa de canto (A1, A3, C1, C3), jogue no canto diametralmente oposto.

7.  **JOGAR EM UM CANTO VAZIO:** Jogue em qualquer casa de canto que ainda esteja vazia (A1, A3, C1, C3).

8.  **JOGAR EM UM LADO VAZIO:** Jogue em qualquer casa lateral do meio que esteja vazia (A2, B1, B3, C2).

Siga esta hierarquia de forma implacável.
`
}
else{
  promptDificuldade = `Você é uma ia focada em ganhar no jogo da velha. seu objetivo é joga para ganhar, e se não puder ganhar não deixe o X ganhar. porém o voce vai jogar um jogo da velha dinamico onde tera no maximo 3 simbolos de cada, quando terminar sua rodada a casa ${ultimaJogadaIa} ficara vazia

AVALIE O TABULEIRO E EXECUTE A PRIMEIRA AÇÃO POSSÍVEL DESTA LISTA, EM ORDEM DE PRIORIDADE ESTRITA:

**HIERARQUIA DE JOGADA PERFEITA:**

1.  **GANHAR:** Se você ('${jogadorIA}') tem duas peças em uma linha, coluna ou diagonal, jogue na casa vazia para completar a trinca e vencer.

2.  **BLOQUEAR:** Se o oponente ('X') tem duas peças em uma linha, coluna ou diagonal, jogue na casa vazia para impedi-lo de vencer na próxima rodada.

3.  **BLOQUEAR GARFO DO OPONENTE:** Se o oponente está prestes a criar um garfo na próxima jogada dele, sua jogada deve ser para bloquear essa criação.
    * **Análise de Garfo:** A principal forma de o oponente criar um garfo é colocando uma peça em uma casa que cria duas linhas de duas peças não bloqueadas. Sua jogada deve ocupar essa casa crucial. Se houver múltiplas possibilidades de garfo, force o oponente a jogar defensivamente em vez de permitir que ele monte o ataque.

4.  **CRIAR GARFO (FORK):** Faça uma jogada que crie duas ameaças de vitória simultaneamente (duas linhas diferentes onde você tem duas peças). Isso força o oponente a bloquear uma, enquanto você vence na outra na próxima jogada.

5.  **JOGAR NO CENTRO:** Se a casa do centro (B2) estiver vazia, jogue nela.

6.  **JOGAR NO CANTO OPOSTO:** Se o oponente estiver em uma casa de canto (A1, A3, C1, C3), jogue no canto diametralmente oposto.

7.  **JOGAR EM UM CANTO VAZIO:** Jogue em qualquer casa de canto que ainda esteja vazia (A1, A3, C1, C3).

8.  **JOGAR EM UM LADO VAZIO:** Jogue em qualquer casa lateral do meio que esteja vazia (A2, B1, B3, C2).

Siga esta hierarquia de forma implacável.
`
}

const promptCompleto = `
${promptDificuldade}
O estado atual do tabuleiro é o seguinte, onde casas vazias são representadas por um espaço:
${representacaoTabuleiro}

É a sua vez de jogar. Você é o jogador '${jogadorIA}'.

Analise o tabuleiro e determine a jogada.

Responda APENAS com a coordenada da casa que você escolheu (por exemplo: A2, C1, etc.). Não adicione nenhuma outra palavra, explicação ou pontuação.
`;


// 5. Retorna o prompt no formato que o n8n precisa
return [
  {
    json: {
      prompt: promptCompleto,
      // Você pode passar outros dados úteis para os próximos nós, se precisar
      estadoAtual: variaveis 
    }
  }
];